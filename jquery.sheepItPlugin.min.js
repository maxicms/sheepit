(function(e){jQuery.fn.sheepIt=function(t){function n(){var e;if(typeof t.beforeClone==="function"){t.beforeClone(ut,mt)}e=mt.cloneWithAttribut(true);if(typeof t.afterClone==="function"){t.afterClone(ut,e)}e.getSource=function(){return ut};return e}function r(e){e.preventDefault();g()}function i(e){e.preventDefault();if(lt.value!==""){y(lt.attr("value"))}}function s(n){n.preventDefault();if(typeof t.beforeRemoveCurrent==="function"){t.beforeRemoveCurrent(ut)}if(t.removeCurrentConfirmation){if(confirm(t.removeCurrentConfirmationMsg)){E(e(this).data("removableClone"))}}else{E(e(this).data("removableClone"))}if(typeof t.afterRemoveCurrent==="function"){t.afterRemoveCurrent(ut)}}function o(e){e.preventDefault();if(t.removeLastConfirmation){if(confirm(t.removeLastConfirmationMsg)){b()}}else{b()}}function u(e){e.preventDefault();if(t.removeAllConfirmation){if(confirm(t.removeAllConfirmationMsg)){w()}}else{w()}}function a(e,t){var n=e.attr(t+"template");if(n){return unescape(n)}var r=e.attr(t);e.attr(t+"template",escape(r));return r}function f(n,r){n.find(bt).each(function(){var i=e(this),s=i.attr("id"),o=i.attr("name");newNameAttr=o.replace(t.indexFormat,r);i.attr("name",newNameAttr);newIdAttr=s.replace(t.indexFormat,r);n.find("label[for='"+s+"']").each(function(){e(this).attr("for",newIdAttr)});i.attr("id",newIdAttr)})}function l(e,t){c(e,t+1)}function c(e,n){e.find(t.labelSelector).html(n);return true}function h(e){return e.find(t.labelSelector).html()}function p(){if(U()){if(P()==0){dt.hideIf();ht.showIf()}else{dt.showIf();ht.showIf()}var e="";if(t.allowRemoveCurrent){e=ut.find(t.removeCurrentSelector);if(W()){e.show()}else{e.hide()}}else{e=ut.find(t.removeCurrentSelector);e.hide()}}else{ht.hideIf();dt.hideIf()}if(!z()){at.hideIf();ft.hideIf()}else{at.showIf();ft.showIf()}if(!W()){ht.hideIf();dt.hideIf()}if(at.css("display")!="none"||ft.css("display")!="none"||dt.css("display")!="none"||ht.css("display")!="none"){vt.show()}else{vt.hide()}}function d(){if(U()){yt.hide();if(t.continuousIndex){var e=0,n=H();do{v(n,e);e++;n=j(n)}while(n!=false)}}else{yt.show()}}function v(e,n){if(typeof n=="undefined"){n=D()}var r=a(e,"id");if(e.attr("id")){e.attr("id",r+n)}f(e,n);l(e,n);if(e.html().indexOf(t.indexFormat)!=-1){var i=new RegExp(t.indexFormat,"ig");e.html(e.html().replace(i,n))}var s=e.find(t.removeCurrentSelector);t.allowRemoveCurrent?s.show():s.hide();return e}function m(){d();p()}function g(r,i){if(typeof r=="undefined"){r=true}if(typeof i=="undefined"){i=false}if(typeof t.beforeAdd==="function"){t.beforeAdd(ut)}var o=false;if(i){if(typeof i=="string"){o=e("#"+i)}else if(typeof i=="object"){o=i}else{return false}o.remove()}else{o=n()}if(z()&&o){o=v(o);var u=o.find(t.removeCurrentSelector).first();u.click(s);u.data("removableClone",o);o.data("formIndex",D());o.data("previousSeparator",false);o.data("nextSeparator",false);o.data("previousForm",false);o.data("nextForm",false);if(U()){var a=B();a.data("nextForm",o);o.data("previousForm",a);if(t.separator){var f=Y();f.insertAfter(a);a.data("nextSeparator",f);o.data("previousSeparator",f)}}t.insertNewForms=="after"?ut.append(o):o.insertAfter(yt);if(t.nestedForms.length>0){var l=0;var c=[];for(l in t.nestedForms){if(typeof t.nestedForms[l].id!="undefined"&&typeof t.nestedForms[l].options!="undefined"){t.nestedForms[l].isNestedForm=true;t.nestedForms[l].parentForm=ut;var h=t.nestedForms[l].id.replace(t.indexFormat,o.data("formIndex"));var p=e("#"+h).sheepIt(t.nestedForms[l].options);c.push(p)}}o.data("nestedForms",c)}st(o);wt.push(o);if(r||t.continuousIndex){m()}if(typeof t.afterAdd==="function"){t.afterAdd(ut,o)}return true}else{return false}}function y(e,t){if(typeof e!="undefined"){e=parseFloat(e);var n=1;for(n=1;n<=e;n++){g(t)}}}function b(e){if(typeof e=="undefined"){e=true}if(W()){S();if(e){m()}return true}else{return false}}function w(e){if(typeof e=="undefined"){e=true}if(X()){for(x=0;x<wt.length;x++){if(wt[x]){S(wt[x])}}if(e){m()}return true}else{return false}}function E(e,t){if(typeof t=="undefined"){t=true}if(W()){S(e);if(t){m()}return true}else{return false}}function S(e){if(typeof e=="undefined"){e=B()}index=e.data("formIndex");if(e.data("previousSeparator")&&e.data("nextSeparator")){e.data("previousSeparator").remove();e.data("previousForm").data("nextSeparator",e.data("nextSeparator"))}else if(e.data("previousSeparator")&&!e.data("nextSeparator")){e.data("previousSeparator").remove();e.data("previousForm").data("nextSeparator",false)}else if(!e.data("previousSeparator")&&e.data("nextSeparator")){e.data("nextSeparator").remove();e.data("nextForm").data("previousSeparator",false)}if(e.data("previousForm")){e.data("previousForm").data("nextForm",e.data("nextForm"))}if(e.data("nextForm")){e.data("nextForm").data("previousForm",e.data("previousForm"))}wt[index]=false;e.remove();return true}function T(){return Et}function N(){if(Et!==false){if(wt.length>1){var e=0;var t=parseFloat(Et+1);for(e=t;e<wt.length;e++){if(wt[e]){Et=e;return true}}return false}else{return false}}else{return false}}function C(){if(Et!==false){if(wt.length>1){var e=0;var t=parseFloat(Et-1);for(e=t;e>=0;e--){if(wt[e]){Et=e;return true}}return false}else{return false}}else{return false}}function k(){Et=false;if(wt.length>0){for(x=0;x<wt.length;x++){if(wt[x]){Et=x;return true}}return false}else{return false}}function L(){Et=false;if(wt.length>0){if(wt[wt.length-1]){Et=wt.length-1;return true}else{var e=0;for(e=wt.length-1;e>=0;e--){if(wt[e]){Et=e;return true}}return false}}else{return false}}function A(){if(wt.length>0){var e=0;for(x=0;x<wt.length;x++){if(wt[x]){e++}}return e}else{return 0}}function O(e){if(typeof e!="undefined"){Et=M(e);if(Et!==false){return true}else{return false}}else{return false}}function M(e){var t=0;var n=false;for(x=0;x<wt.length;x++){if(wt[x]){t++;if(e==t){n=x}}}return n}function _(e){var t=0;var n=0;for(t=0;t<=e;t++){if(wt[t]){n++}}return n}function D(){return wt.length}function P(){return A()}function H(){if(k()!==false){return I()}else{return false}}function B(){if(L()!==false){return I()}else{return false}}function j(e){if(e){return e.data("nextForm")}else if(T()!==false){if(N()!==false){return I()}else{return false}}else{return false}}function F(e){if(e){return e.data("previousForm")}else if(T()!==false){if(C()!==false){return I()}else{return false}}else{return false}}function I(){if(T()!==false){return wt[T()]}else{return false}}function q(e){if(U()){if(typeof e!="undefined"){O(e);return I()}else{return B()}}else{return false}}function R(){if(U()){k();var e=0;var t=[];for(e=0;e<P();e++){t.push(I());N()}return t}else{return false}}function U(){return P()>0?true:false}function z(){if(t.maxFormsCount==0){return true}else{return P()<t.maxFormsCount?true:false}}function W(){return P()>t.minFormsCount?true:false}function X(){return t.minFormsCount==0?true:false}function V(t){if(e("#"+t.attr("id")).length>0){return true}else{return false}}function J(n,r){var i="";if(typeof n=="number"){n++;if(n>P()){g()}i=q(n);K(i,r)}else if(typeof n=="string"){i=e("#"+n);K(i,r)}if(typeof t.afterFill==="function"){t.afterFill(ut,i,r)}}function K(t,n){var r=0;e.each(n,function(e,n){var i=ut.attr("id");var s=t.data("formIndex");if(e.indexOf("#form#")!=-1||e.indexOf("#index#")!=-1){e=e.replace("#form#",i);e=e.replace("#index#",s)}else{e=i+"_"+s+"_"+e}var o=t.find(':input[id="'+e+'"]');if(o.length==0){o=t.find(':input[name="'+e+'"]');if(o.length==0){o=t.find(':input[name="'+e+'[]"]')}}if(o.length>0){var u=false;if(typeof n=="object"){u=true}var a=false;if(o.length>1){a=true}if(a){if(u){var f=[];f["fields"]=[];f["values"]=[];r=0;for(r in n){f["fields"].push(o.filter('[value="'+n[r]+'"]'));f["values"].push(n[r])}r=0;for(r in f["fields"]){Q(f["fields"][r],f["values"][r])}}else{Q(o.filter('[value="'+n+'"]'),n)}}else{if(u){r=0;for(r in n){Q(o,n[r])}}else{Q(o,n)}}}else{if(typeof t.data("nestedForms")!="undefined"){if(t.data("nestedForms").length>0){r=0;for(r in t.data("nestedForms")){if(e==t.data("nestedForms")[r].attr("id")&&typeof n=="object"){t.data("nestedForms")[r].inject(n)}}}}}})}function Q(t,n){var r=t.attr("type");if(r=="text"||r=="hidden"||r=="password"){t.attr("value",n);return true}else if(r=="textarea"){t.text(n);return true}else if(r=="checkbox"||r=="radio"){t.attr("checked","checked");return true}else if(r=="select-one"||r=="select-multiple"){t.find("option").each(function(){if(e(this).text()==n||e(this).attr("value")==n){e(this).attr("selected","selected")}});return true}else{return false}}function G(){if(t.separator!=""){return true}else{return false}}function Y(){if(G()){return e(t.separator)}else{return false}}function Z(n){t=[];t=e.extend(St,n);ot(t)}function et(){return t}function tt(t){var n=ut.find(t);if(n.length){return n}return e(t)}function nt(){ut.hide();at=tt(t.addSelector);ft=tt(t.addNSelector);lt=tt(t.addNInputSelector);ct=tt(t.addNButtonSelector);ht=tt(t.removeLastSelector);pt=tt(t.removeCurrentSelector);dt=tt(t.removeAllSelector);vt=tt(t.controlsSelector);if(at.length==0){t.allowAdd=false}if(ft.length==0){t.allowAddN=false}if(ht.length==0){t.allowRemoveLast=false}if(dt.length==0){t.allowRemoveAll=false}rt(at,t.allowAdd,r);rt(ft,t.allowAddN,i,ct);rt(ht,t.allowRemoveLast,o);rt(dt,t.allowRemoveAll,u);at.init();ft.init();ht.init();dt.init();gt=tt(t.formTemplateSelector);yt=tt(t.noFormsTemplateSelector);mt=gt.cloneWithAttribut(true);gt.remove();var e=0;if(t.pregeneratedForms.length>0){for(e=0;e<t.pregeneratedForms.length;e++){g(false,t.pregeneratedForms[e])}}if(t.iniFormsCount>P()){e=0;var n=t.iniFormsCount-P();for(e=1;e<=n;e++){g(false)}}if(t.data){ut.inject(t.data)}m();ut.show()}function rt(t,n,r,i){if(typeof i=="undefined"){i=false}e.extend(t,{hideIf:function(e,r){if(n){t.hide(e,r)}},showIf:function(e,r){if(n){t.show(e,r)}},init:function(){if(n){if(i){i.click(r)}else{t.click(r)}t.show()}else{t.hide()}}})}function it(n){e.extend(n,{getAddControl:function(){return at},getAddNControl:function(){return ft},getRemoveLastControl:function(){return ht},getRemoveAllControl:function(){return dt},getOptions:function(){return et()},getOption:function(e){return t[e]},setOption:function(e,n){if(typeof e!="undefined"&&typeof n!="undefined"){t[e]=n;return t[e]}else{return false}},getForms:function(){return R()},getAllForms:function(){return R()},getForm:function(e){if(typeof e!="undefined"){e++}return q(e)},getLastForm:function(){return q()},getFirstForm:function(){k();return I()},addForm:function(){return g()},addNForms:function(e){return y(e)},getFormsCount:function(){return P()},hasForms:function(){return U()},canAddForm:function(){return z()},canRemoveAllForms:function(){return X()},canRemoveForm:function(){return W()},removeAllForms:function(){return w()},removeLastForm:function(){return b()},removeFirstForm:function(){k();return S(I())},removeForm:function(e){if(typeof e!="undefined"){e++}return S(q(e))},inject:function(t){e.each(t,e.proxy(J,n))}})}function st(t){e.extend(t,{setLabel:function(e){return c(t,e)},getLabel:function(){return h(t)},inject:function(e){K(t,e)},getNestedForms:function(){return t.data("nestedForms")},getNestedForm:function(e){return t.data("nestedForms")[e]},getPosition:function(){return _(t.data("formIndex"))},getPreviousForm:function(){return F(t)},getNextForm:function(){return j(t)},removeForm:function(){return S(t)}})}function ot(e){if(e.maxFormsCount>0){if(e.maxFormsCount<e.minFormsCount){e.maxFormsCount=e.minFormsCount}if(e.iniFormsCount<e.minFormsCount||e.iniFormsCount>e.maxFormsCount){e.iniFormsCount=e.minFormsCount}}else{if(e.iniFormsCount<e.minFormsCount){e.iniFormsCount=e.minFormsCount}}if(!X()){e.allowRemoveAll=false}}var ut=e(this).first();it(ut);var at,ft,lt,ct,ht,pt,dt,vt,mt,gt,yt,bt="input, checkbox, select, textarea",wt=[],Et=false,St={addSelector:"#"+e(this).attr("id")+"_add",addNSelector:"#"+e(this).attr("id")+"_add_n",addNInputSelector:"#"+e(this).attr("id")+"_add_n_input",addNButtonSelector:"#"+e(this).attr("id")+"_add_n_button",removeLastSelector:"#"+e(this).attr("id")+"_remove_last",removeCurrentSelector:"#"+e(this).attr("id")+"_remove_current",removeAllSelector:"#"+e(this).attr("id")+"_remove_all",controlsSelector:"#"+e(this).attr("id")+"_controls",labelSelector:"#"+e(this).attr("id")+"_label",allowRemoveLast:true,allowRemoveCurrent:true,allowRemoveAll:false,allowAdd:true,allowAddN:false,removeLastConfirmation:false,removeCurrentConfirmation:false,removeAllConfirmation:true,removeLastConfirmationMsg:"Are you sure?",removeCurrentConfirmationMsg:"Are you sure?",removeAllConfirmationMsg:"Are you sure?",formTemplateSelector:"#"+e(this).attr("id")+"_template",noFormsTemplateSelector:"#"+e(this).attr("id")+"_noforms_template",separator:'<div style="width:100%; border-top:1px solid #ff0000; margin: 10px 0px;"></div>',iniFormsCount:1,maxFormsCount:20,minFormsCount:1,incrementCount:1,noFormsMsg:"No forms to display",indexFormat:"#index#",data:[],pregeneratedForms:[],nestedForms:[],isNestedForm:false,parentForm:{},beforeClone:function(){},afterClone:function(){},beforeAdd:function(){},afterAdd:function(){},afterFill:function(){},afterRemoveCurrent:function(){},beforeRemoveCurrent:function(){},insertNewForms:"after",continuousIndex:true};Z(t);nt();return ut};jQuery.fn.cloneWithAttribut=function(t){if(jQuery.support.noCloneEvent){return e(this).clone(t)}else{e(this).find("*").each(function(){e(this).data("name",e(this).attr("name"))});var n=e(this).clone(t);n.find("*").each(function(){e(this).attr("name",e(this).data("name"))});return n}}})(jQuery)
